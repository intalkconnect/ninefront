import React, { useEffect, useMemo, useState, useCallback } from 'react';
import { apiGet, apiPost, apiDelete, apiPut } from '../../../shared/apiClient';
import styles from './styles/QuickReplies.module.css';

/**
 * QuickReplies ‚Äì Componente melhorado com edi√ß√£o inline e melhor UX
 * Endpoints esperados no back:
 *  GET    /quickReplies         ‚Üí lista
 *  POST   /quickReplies         ‚Üí { title, content }
 *  PUT    /quickReplies/:id     ‚Üí { title, content }
 *  DELETE /quickReplies/:id     ‚Üí remove
 */
const QuickReplies = () => {
  const [items, setItems] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [successMsg, setSuccessMsg] = useState(null);

  // Estados do formul√°rio
  const [title, setTitle] = useState('');
  const [content, setContent] = useState('');
  const [query, setQuery] = useState('');
  
  // Estados de a√ß√£o
  const [deletingId, setDeletingId] = useState(null);
  const [editingId, setEditingId] = useState(null);
  const [editTitle, setEditTitle] = useState('');
  const [editContent, setEditContent] = useState('');
  const [savingId, setSavingId] = useState(null);

  // Toast de sucesso
  const showSuccess = useCallback((msg) => {
    setSuccessMsg(msg);
    setTimeout(() => setSuccessMsg(null), 3000);
  }, []);

  // Carregamento inicial
  const load = async () => {
    setLoading(true);
    setError(null);
    try {
      const data = await apiGet('/quickReplies');
      setItems(Array.isArray(data) ? data : []);
    } catch (e) {
      console.error('Erro ao carregar:', e);
      setError('Falha ao carregar respostas r√°pidas. Verifique sua conex√£o.');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => { 
    load(); 
  }, []);

  // Filtros e ordena√ß√£o
  const filtered = useMemo(() => {
    const q = query.trim().toLowerCase();
    const base = [...items].sort((a, b) => {
      const titleA = String(a.title || '').toLowerCase();
      const titleB = String(b.title || '').toLowerCase();
      return titleA.localeCompare(titleB);
    });
    
    if (!q) return base;
    
    return base.filter((r) => {
      const title = String(r.title || '').toLowerCase();
      const content = String(r.content || '').toLowerCase();
      return title.includes(q) || content.includes(q);
    });
  }, [items, query]);

  // Criar nova resposta
  const handleCreate = async (e) => {
    e.preventDefault();
    setError(null);
    
    const trimmedTitle = title.trim();
    const trimmedContent = content.trim();
    
    if (!trimmedTitle || !trimmedContent) {
      setError('Por favor, preencha o t√≠tulo e o conte√∫do.');
      return;
    }

    if (trimmedTitle.length > 100) {
      setError('O t√≠tulo deve ter no m√°ximo 100 caracteres.');
      return;
    }

    try {
      const created = await apiPost('/quickReplies', { 
        title: trimmedTitle, 
        content: trimmedContent 
      });
      
      setItems(prev => [...prev, created]);
      setTitle('');
      setContent('');
      showSuccess('‚úÖ Resposta r√°pida criada com sucesso!');
    } catch (e) {
      console.error('Erro ao criar:', e);
      setError('Erro ao criar resposta. Tente novamente.');
    }
  };

  // Iniciar edi√ß√£o
  const startEdit = (item) => {
    setEditingId(item.id);
    setEditTitle(item.title || '');
    setEditContent(item.content || '');
  };

  // Cancelar edi√ß√£o
  const cancelEdit = () => {
    setEditingId(null);
    setEditTitle('');
    setEditContent('');
  };

  // Salvar edi√ß√£o
  const saveEdit = async (id) => {
    if (!editTitle.trim() || !editContent.trim()) {
      setError('T√≠tulo e conte√∫do s√£o obrigat√≥rios.');
      return;
    }

    setSavingId(id);
    setError(null);
    
    try {
      const updated = await apiPut(`/quickReplies/${id}`, {
        title: editTitle.trim(),
        content: editContent.trim()
      });
      
      setItems(prev => prev.map(item => 
        item.id === id ? { ...item, ...updated } : item
      ));
      
      setEditingId(null);
      setEditTitle('');
      setEditContent('');
      showSuccess('‚úÖ Resposta atualizada com sucesso!');
    } catch (e) {
      console.error('Erro ao salvar:', e);
      setError('Erro ao salvar altera√ß√µes. Tente novamente.');
    } finally {
      setSavingId(null);
    }
  };

  // Remover resposta
  const handleDelete = async (id) => {
    if (!window.confirm('Tem certeza que deseja remover esta resposta?')) {
      return;
    }

    setDeletingId(id);
    setError(null);
    
    try {
      await apiDelete(`/quickReplies/${id}`);
      setItems(prev => prev.filter(r => r.id !== id));
      showSuccess('üóëÔ∏è Resposta removida com sucesso!');
    } catch (e) {
      console.error('Erro ao excluir:', e);
      setError('Erro ao excluir resposta. Tente novamente.');
    } finally {
      setDeletingId(null);
    }
  };

  // Copiar conte√∫do
  const handleCopy = async (text) => {
    try {
      await navigator.clipboard.writeText(text || '');
      showSuccess('üìã Conte√∫do copiado para a √°rea de transfer√™ncia!');
    } catch (e) {
      console.error('Erro ao copiar:', e);
      setError('N√£o foi poss√≠vel copiar. Seu navegador pode n√£o suportar esta funcionalidade.');
    }
  };

  // Limpar busca
  const clearSearch = () => setQuery('');

  return (
    <div className={styles.container}>
      <div className={styles.header}>
        <div>
          <h1 className={styles.title}>
            <span className={styles.titleIcon}>üí¨</span>
            Respostas R√°pidas
          </h1>
          <p className={styles.subtitle}>
            Gerencie atalhos de mensagens para agilizar o atendimento ao cliente.
          </p>
          
          {/* Sistema de alertas melhorado */}
          {error && (
            <div className={styles.alertErr} role="alert">
              <span className={styles.alertIcon}>‚ö†Ô∏è</span>
              <span>{error}</span>
              <button 
                className={styles.alertClose}
                onClick={() => setError(null)}
                aria-label="Fechar alerta"
              >
                ‚úï
              </button>
            </div>
          )}
          
          {successMsg && (
            <div className={styles.alertOk} role="alert">
              <span>{successMsg}</span>
              <button 
                className={styles.alertClose}
                onClick={() => setSuccessMsg(null)}
                aria-label="Fechar alerta"
              >
                ‚úï
              </button>
            </div>
          )}
        </div>
      </div>

      {/* Formul√°rio de cria√ß√£o aprimorado */}
      <div className={styles.card}>
        <div className={styles.cardHead}>
          <div className={styles.cardTitle}>
            <span className={styles.cardIcon}>‚ú®</span>
            Nova Resposta
          </div>
        </div>
        <form onSubmit={handleCreate} className={styles.formGrid}>
          <div className={styles.inputGroup}>
            <label htmlFor="title" className={styles.label}>
              T√≠tulo *
            </label>
            <input
              id="title"
              className={styles.input}
              placeholder="Ex: Sauda√ß√£o inicial, Informa√ß√µes de hor√°rio..."
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              maxLength={100}
              required
            />
            <div className={styles.inputHelper}>
              {title.length}/100 caracteres
            </div>
          </div>
          
          <div className={styles.inputGroup}>
            <label htmlFor="content" className={styles.label}>
              Conte√∫do *
            </label>
            <textarea
              id="content"
              className={styles.textarea}
              rows={4}
              placeholder="Digite o conte√∫do da resposta r√°pida aqui..."
              value={content}
              onChange={(e) => setContent(e.target.value)}
              required
            />
            <div className={styles.inputHelper}>
              {content.length} caracteres
            </div>
          </div>
          
          <div className={styles.formActions}>
            <button 
              className={styles.btnPrimary} 
              type="submit"
              disabled={!title.trim() || !content.trim()}
            >
              <span className={styles.btnIcon}>‚ûï</span>
              Adicionar Resposta
            </button>
          </div>
        </form>
      </div>

      {/* Lista de respostas melhorada */}
      <div className={styles.card}>
        <div className={styles.cardHead}>
          <div className={styles.cardTitle}>
            <span className={styles.cardIcon}>üìã</span>
            Respostas Cadastradas
          </div>
          
          <div className={styles.cardActions}>
            <div className={styles.searchGroup}>
              <input
                className={styles.searchInput}
                placeholder="üîç Buscar por t√≠tulo ou conte√∫do..."
                value={query}
                onChange={(e) => setQuery(e.target.value)}
              />
              {query && (
                <button 
                  className={styles.searchClear}
                  onClick={clearSearch}
                  title="Limpar busca"
                >
                  ‚úï
                </button>
              )}
            </div>
            <div className={styles.counter}>
              <span className={styles.counterNumber}>{filtered.length}</span>
              <span className={styles.counterLabel}>
                {filtered.length === 1 ? 'item' : 'itens'}
              </span>
            </div>
          </div>
        </div>

        <div className={styles.tableWrap}>
          <table className={styles.table} role="table">
            <thead>
              <tr>
                <th style={{ minWidth: 280 }}>T√≠tulo</th>
                <th>Conte√∫do</th>
                <th style={{ width: 200 }}>A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              {loading && (
                <tr>
                  <td colSpan={3} className={styles.loading}>
                    <div className={styles.spinner}></div>
                    <span>Carregando respostas...</span>
                  </td>
                </tr>
              )}

              {!loading && filtered.length === 0 && (
                <tr>
                  <td colSpan={3} className={styles.empty}>
                    {query ? (
                      <>
                        <span className={styles.emptyIcon}>üîç</span>
                        <div>Nenhuma resposta encontrada para "<strong>{query}</strong>"</div>
                        <button className={styles.btnLink} onClick={clearSearch}>
                          Limpar filtro
                        </button>
                      </>
                    ) : (
                      <>
                        <span className={styles.emptyIcon}>üìù</span>
                        <div>Nenhuma resposta r√°pida cadastrada ainda.</div>
                        <div className={styles.emptyHelper}>
                          Use o formul√°rio acima para criar sua primeira resposta!
                        </div>
                      </>
                    )}
                  </td>
                </tr>
              )}

              {!loading && filtered.map((item) => (
                <tr key={item.id} className={styles.tableRow}>
                  <td className={styles.cellKey}>
                    {editingId === item.id ? (
                      <div className={styles.editForm}>
                        <input
                          className={styles.editInput}
                          value={editTitle}
                          onChange={(e) => setEditTitle(e.target.value)}
                          placeholder="T√≠tulo"
                          autoFocus
                        />
                      </div>
                    ) : (
                      <>
                        <div className={styles.keyTitle}>{item.title}</div>
                        <div className={styles.keySub}>ID: {item.id}</div>
                      </>
                    )}
                  </td>
                  
                  <td className={styles.cellContent}>
                    {editingId === item.id ? (
                      <textarea
                        className={styles.editTextarea}
                        value={editContent}
                        onChange={(e) => setEditContent(e.target.value)}
                        rows={3}
                        placeholder="Conte√∫do"
                      />
                    ) : (
                      <pre className={styles.code} title={item.content}>
                        {item.content}
                      </pre>
                    )}
                  </td>
                  
                  <td className={styles.cellActions}>
                    {editingId === item.id ? (
                      <div className={styles.editActions}>
                        <button
                          className={styles.btnSuccess}
                          onClick={() => saveEdit(item.id)}
                          disabled={savingId === item.id}
                        >
                          {savingId === item.id ? 'üíæ Salvando...' : '‚úÖ Salvar'}
                        </button>
                        <button
                          className={styles.btn}
                          onClick={cancelEdit}
                          disabled={savingId === item.id}
                        >
                          ‚ùå Cancelar
                        </button>
                      </div>
                    ) : (
                      <div className={styles.actions}>
                        <button 
                          className={styles.btn} 
                          onClick={() => handleCopy(item.content)}
                          title="Copiar conte√∫do"
                        >
                          üìã Copiar
                        </button>
                        <button 
                          className={styles.btnSecondary} 
                          onClick={() => startEdit(item)}
                          title="Editar resposta"
                        >
                          ‚úèÔ∏è Editar
                        </button>
                        <button
                          className={styles.btnDanger}
                          onClick={() => handleDelete(item.id)}
                          disabled={deletingId === item.id}
                          title="Remover resposta"
                        >
                          {deletingId === item.id ? 'üóëÔ∏è Removendo...' : 'üóëÔ∏è Remover'}
                        </button>
                      </div>
                    )}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      {/* Footer com informa√ß√µes √∫teis */}
      <div className={styles.footer}>
        <div className={styles.footerContent}>
          <div className={styles.tip}>
            üí° <strong>Dica:</strong> Use t√≠tulos descritivos para encontrar rapidamente suas respostas!
          </div>
        </div>
      </div>
    </div>
  );
};

export default QuickReplies;
